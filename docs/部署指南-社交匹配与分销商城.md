# 社交匹配与分销商城 - 部署指南

## 前置要求

- JDK 17+
- MySQL 8.0+
- Redis 6.0+
- Maven 3.8+

## 快速开始

### 1. 数据库初始化

执行数据库初始化脚本:

```bash
# 连接MySQL
mysql -u root -p

# 创建数据库(如果还没有)
CREATE DATABASE `wr-chat-shejiao` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 使用数据库
USE `wr-chat-shejiao`;

# 执行初始化脚本
source /path/to/sql/wr-chat-shejiao.sql
source /path/to/sql/adjustments_2025-11-13.sql
```

或者使用命令行一键执行:

```bash
mysql -u root -p wr-chat-shejiao < sql/wr-chat-shejiao.sql
mysql -u root -p wr-chat-shejiao < sql/adjustments_2025-11-13.sql
```

### 2. 配置文件修改

编辑 `application-dev.yml` (或对应环境的配置文件):

```yaml
spring:
  datasource:
    url: jdbc:mysql://your_host:3306/wr-chat-shejiao
    username: your_username
    password: your_password
  data:
    redis:
      host: your_redis_host
      port: 6379
      password: your_redis_password
```

### 3. 编译项目

```bash
cd im_chat_server/im-platform
mvn clean package -DskipTests
```

### 4. 启动服务

```bash
java -jar target/im-platform-1.0.0.jar --spring.profiles.active=dev
```

或者在IDE中直接运行 `IMPlatformApp.java`

### 5. 验证部署

访问 Swagger UI 文档:
```
http://localhost:8888/api/doc.html
```

检查以下接口是否可用:
- 社交匹配: `/match/*`
- 匹配推荐: `/match/recommend/*`
- 分销系统: `/distribution/*`
- 分销统计: `/distribution/statistics/*`
- 商城系统: `/mall/*`

## 功能配置

### iOS内购配置

如果需要支持iOS内购,需要配置以下内容:

1. **Apple Developer配置**:
   - 登录 [App Store Connect](https://appstoreconnect.apple.com/)
   - 创建内购商品(In-App Purchase)
   - 配置商品ID、价格等信息

2. **共享密钥配置** (用于订阅验证):
   - 在App Store Connect中生成共享密钥
   - 在代码中配置(可选):
   ```java
   IOSReceiptVerifyUtil.verifyReceipt(receipt, "your_shared_secret", false);
   ```

3. **测试环境**:
   - 使用沙盒账号进行测试
   - 工具会自动识别沙盒收据并切换到沙盒验证服务器

### 短信服务配置

配置阿里云短信服务(用于手机号注册):

```yaml
sms:
  platform: aliyun
  access-key: "your_access_key"      # 替换为真实的AccessKey
  secret-key: "your_secret_key"      # 替换为真实的SecretKey
  sign-name: 你的签名
  template-id: SMS_XXXXXX
```

### 邮件服务配置

配置邮件服务(用于邮箱注册):

```yaml
mail:
  host: smtp.163.com
  port: 465
  ssl: true
  from: your_email@163.com
  pass: your_auth_code              # 邮箱授权码
  subject: '您收到一条注册验证码'
  content: '您正在注册账号,验证码为: ${code}'
```

## 数据库表说明

### 社交匹配表

- **im_user_match_record**: 用户匹配操作记录(浏览、喜欢、不喜欢)
- **im_user_match**: 用户匹配关系表(双向匹配成功记录)

### 分销系统表

- **im_distribution_user**: 分销商信息表
- **im_distribution_commission**: 佣金记录表

### 商城系统表

- **im_mall_product**: 商品信息表
- **im_mall_order**: 订单信息表

## API接口清单

### 社交匹配接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /match/candidates | GET | 获取待匹配用户 |
| /match/action | POST | 记录匹配操作 |
| /match/history | GET | 获取匹配历史 |
| /match/matched | GET | 获取已匹配用户 |
| /match/check | GET | 检查是否匹配 |

### 智能推荐接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /match/recommend/smart | GET | 智能推荐 |
| /match/recommend/by-interest | GET | 兴趣推荐 |
| /match/recommend/nearby | GET | 附近的人 |
| /match/recommend/match-score | GET | 计算匹配度 |

### 分销系统接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /distribution/activate | POST | 激活分销商 |
| /distribution/info | GET | 获取分销商信息 |
| /distribution/commission/list | GET | 佣金明细 |
| /distribution/commission/withdraw | POST | 佣金提现 |
| /distribution/referral-code | GET | 根据推广码获取用户ID |

### 分销统计接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /distribution/statistics/overview | GET | 统计概览 |
| /distribution/statistics/team | GET | 团队列表 |
| /distribution/statistics/daily | GET | 每日统计 |
| /distribution/statistics/ranking | GET | 排行榜 |
| /distribution/statistics/estimate | GET | 预估佣金 |

### 商城系统接口

| 接口 | 方法 | 说明 |
|-----|------|------|
| /mall/product/list | GET | 商品列表 |
| /mall/product/{id} | GET | 商品详情 |
| /mall/order/create | POST | 创建订单 |
| /mall/order/list | GET | 订单列表 |
| /mall/order/{id} | GET | 订单详情 |
| /mall/order/pay/{id} | POST | 支付订单 |
| /mall/order/cancel/{id} | POST | 取消订单 |

## 常见问题

### 1. 数据库连接失败

**问题**: 启动时提示数据库连接失败

**解决方案**:
- 检查MySQL服务是否启动
- 确认数据库连接配置是否正确
- 检查数据库用户权限
- 确认防火墙设置

### 2. Redis连接失败

**问题**: 启动时提示Redis连接失败

**解决方案**:
- 检查Redis服务是否启动
- 确认Redis连接配置是否正确
- 检查Redis密码设置
- 确认防火墙设置

### 3. iOS支付验证失败

**问题**: iOS内购验证返回错误

**解决方案**:
- 检查收据格式是否正确(应为Base64编码)
- 确认使用的是正确的验证环境(沙盒/生产)
- 检查网络连接是否正常
- 查看详细错误码和消息

### 4. 分销佣金计算错误

**问题**: 佣金金额计算不正确

**解决方案**:
- 检查商品的佣金比例配置
- 确认分销关系是否正确建立
- 检查订单状态是否为已支付
- 查看佣金记录表中的详细信息

### 5. 匹配推荐结果为空

**问题**: 获取推荐用户时返回空列表

**解决方案**:
- 检查数据库中是否有足够的用户数据
- 确认用户状态是否正常(未禁用)
- 检查是否所有用户都已被浏览过
- 调整推荐算法的筛选条件

## 性能优化建议

### 1. 数据库优化

```sql
-- 为常用查询字段添加索引
ALTER TABLE im_user_match_record ADD INDEX idx_user_action (user_id, action_type, created_time);
ALTER TABLE im_distribution_commission ADD INDEX idx_distributor_status (distributor_user_id, status, created_time);
ALTER TABLE im_mall_order ADD INDEX idx_user_status (user_id, status, created_time);
```

### 2. Redis缓存

建议缓存以下数据:
- 热门商品列表
- 分销商统计数据
- 用户匹配推荐列表

### 3. 异步处理

对以下操作使用异步处理:
- 佣金计算和分配
- 推送通知
- 统计数据更新

### 4. 分页查询

所有列表查询都应使用分页:
```java
// 示例
Page<User> page = new Page<>(pageNum, pageSize);
```

## 监控和日志

### 日志配置

日志文件位置: `log/im-platform.log`

关键日志:
- 匹配成功: `Match created between user X and user Y`
- 佣金处理: `Commission processed for distributor X on order Y`
- iOS支付验证: `iOS receipt verified successfully`

### 监控指标

建议监控以下指标:
- 匹配成功率
- 订单支付成功率
- 佣金结算准确性
- API响应时间
- 数据库查询性能

## 安全注意事项

1. **API鉴权**: 所有接口都应该进行用户身份验证
2. **支付验证**: iOS收据必须与Apple服务器验证
3. **佣金审核**: 建议设置提现审核机制
4. **数据加密**: 敏感信息(密码、支付凭证)应加密存储
5. **SQL注入防护**: 使用预编译语句,避免SQL注入
6. **XSS防护**: 对用户输入进行过滤和转义

## 技术支持

如有问题,请通过以下方式联系:
- 提交GitHub Issue
- 发送邮件至技术支持邮箱
- 查看在线文档和FAQ

## 更新日志

### v1.0.0 (2025-01-12)
- ✅ 实现社交匹配基础功能
- ✅ 实现二级分销系统
- ✅ 实现商城系统
- ✅ 添加智能推荐算法
- ✅ 添加分销统计报表
- ✅ 集成iOS内购支付验证
- ✅ 完善API文档
### 6. 前端开发环境（UniApp）

开发态统一通过同源代理访问后端：

```
im_chat_uniapp/.env.js:
ENV = "DEV"
UNI_APP.BASE_URL = "/api"
UNI_APP.WS_URL = "/im"

im_chat_uniapp/vite.config.js:
server.proxy['/api'] -> http://127.0.0.1:8888/api
server.proxy['/im']  -> ws://127.0.0.1:8878/im (ws: true)
```
