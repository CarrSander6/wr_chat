# 社交匹配与分销商城功能说明

本文档说明新增的社交匹配、二级分销、商城功能的实现和使用。

## 功能概述

### 1. 社交匹配功能

类似于社交应用的匹配机制，用户可以浏览其他用户并进行"喜欢"或"不喜欢"的操作。当双方互相喜欢时，系统会创建匹配关系，用户可以开始聊天。

**核心特性：**
- 卡片式浏览界面，支持左右滑动
- 记录用户的浏览和操作历史
- 双向匹配机制
- 匹配成功后可直接跳转聊天
- 查看喜欢/不喜欢的历史记录
- 查看已匹配的用户列表

**技术实现：**
- 后端：MatchService、MatchController
- 前端：match.vue、match-history.vue、match-list.vue
- 数据库：im_user_match_record、im_user_match

### 2. 二级分销系统

合规的二级分销机制，支持直推（一级）和间推（二级）两层分润。

**核心特性：**
- 分销商激活机制
- 自动生成推广码
- 两级分销佣金计算
- 佣金明细查看
- 佣金提现到余额
- 直推和间推人数统计

**技术实现：**
- 后端：DistributionService、DistributionController
- 前端：distribution-center.vue、commission-list.vue
- 数据库：im_distribution_user、im_distribution_commission

**分销规则：**
- 直推（一级）：直接邀请的用户购买商品，获得一级佣金
- 间推（二级）：直推用户邀请的用户购买商品，获得二级佣金
- 佣金比例由商品设置决定

### 3. 商城系统

支持虚拟商品和实物商品的销售，集成iOS内购支付。

**核心特性：**
- 商品列表和详情展示
- 支持余额支付和iOS内购
- 订单管理（创建、支付、取消）
- 库存管理
- 销量统计
- 分销佣金自动结算

**技术实现：**
- 后端：MallService、MallController
- 前端：mall.vue、product-detail.vue、order-list.vue
- 数据库：im_mall_product、im_mall_order

**支付方式：**
1. 余额支付：使用用户账户余额直接支付
2. iOS内购：通过Apple IAP进行支付（需要配置Apple内购）

## 数据库设计

### 用户匹配记录表 (im_user_match_record)

```sql
CREATE TABLE `im_user_match_record` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL COMMENT '操作用户ID',
  `target_user_id` bigint(20) NOT NULL COMMENT '被浏览用户ID',
  `action_type` tinyint(4) NOT NULL DEFAULT '0' COMMENT '操作类型: 0-仅浏览 1-喜欢 2-不喜欢',
  `created_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`, `target_user_id`)
);
```

### 用户匹配表 (im_user_match)

```sql
CREATE TABLE `im_user_match` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user1_id` bigint(20) NOT NULL COMMENT '用户1的ID',
  `user2_id` bigint(20) NOT NULL COMMENT '用户2的ID',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '匹配状态: 1-已匹配 2-已取消',
  `match_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `created_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_pair` (`user1_id`, `user2_id`)
);
```

### 分销用户表 (im_distribution_user)

```sql
CREATE TABLE `im_distribution_user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `referral_code` varchar(32) NOT NULL COMMENT '推广码',
  `parent_user_id` bigint(20) DEFAULT NULL COMMENT '上级分销商用户ID（一级）',
  `grand_parent_user_id` bigint(20) DEFAULT NULL COMMENT '二级上级分销商用户ID',
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '0-未激活 1-已激活 2-已禁用',
  `total_commission` decimal(10,2) NOT NULL DEFAULT '0.00',
  `available_commission` decimal(10,2) NOT NULL DEFAULT '0.00',
  `withdrawn_commission` decimal(10,2) NOT NULL DEFAULT '0.00',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  UNIQUE KEY `uk_referral_code` (`referral_code`)
);
```

### 分销佣金记录表 (im_distribution_commission)

```sql
CREATE TABLE `im_distribution_commission` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `distributor_user_id` bigint(20) NOT NULL COMMENT '分销商用户ID',
  `order_id` bigint(20) NOT NULL COMMENT '订单ID',
  `buyer_user_id` bigint(20) NOT NULL COMMENT '购买用户ID',
  `commission_type` tinyint(4) NOT NULL COMMENT '1-直推佣金 2-间推佣金',
  `order_amount` decimal(10,2) NOT NULL,
  `commission_amount` decimal(10,2) NOT NULL,
  `commission_rate` decimal(5,4) NOT NULL,
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '0-待结算 1-已结算 2-已取消',
  PRIMARY KEY (`id`)
);
```

### 商城商品表 (im_mall_product)

```sql
CREATE TABLE `im_mall_product` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `product_name` varchar(200) NOT NULL,
  `description` text,
  `image_url` varchar(500) DEFAULT NULL,
  `price` decimal(10,2) NOT NULL,
  `original_price` decimal(10,2) DEFAULT NULL,
  `stock` int(11) NOT NULL DEFAULT '0',
  `sales_count` int(11) NOT NULL DEFAULT '0',
  `product_type` tinyint(4) NOT NULL DEFAULT '1' COMMENT '1-虚拟商品 2-实物商品',
  `status` tinyint(4) NOT NULL DEFAULT '1' COMMENT '0-下架 1-上架',
  `enable_distribution` tinyint(1) NOT NULL DEFAULT '0',
  `level1_commission_rate` decimal(5,4) DEFAULT '0.0000',
  `level2_commission_rate` decimal(5,4) DEFAULT '0.0000',
  PRIMARY KEY (`id`)
);
```

### 商城订单表 (im_mall_order)

```sql
CREATE TABLE `im_mall_order` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `order_no` varchar(64) NOT NULL,
  `user_id` bigint(20) NOT NULL,
  `product_id` bigint(20) NOT NULL,
  `product_name` varchar(200) NOT NULL,
  `quantity` int(11) NOT NULL DEFAULT '1',
  `unit_price` decimal(10,2) NOT NULL,
  `total_amount` decimal(10,2) NOT NULL,
  `payment_method` tinyint(4) NOT NULL COMMENT '1-余额支付 2-iOS内购',
  `ios_receipt` text,
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '0-待支付 1-已支付 2-已取消 3-已完成',
  `referrer_user_id` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`)
);
```

## API接口

### 社交匹配接口

#### 1. 获取待匹配用户
```
GET /match/candidates?limit=10
```

#### 2. 记录匹配操作
```
POST /match/action
Body: {
  "targetUserId": 123,
  "actionType": 1  // 1-喜欢 2-不喜欢
}
Response: boolean (是否匹配成功)
```

#### 3. 获取匹配历史
```
GET /match/history?actionType=1&pageNum=1&pageSize=20
```

#### 4. 获取已匹配用户
```
GET /match/matched
```

### 分销系统接口

#### 1. 激活分销商
```
POST /distribution/activate
Body: {
  "referralCode": "ABC12345"  // 可选，推荐人推广码
}
Response: string (推广码)
```

#### 2. 获取分销商信息
```
GET /distribution/info
```

#### 3. 获取佣金明细
```
GET /distribution/commission/list?pageNum=1&pageSize=20
```

#### 4. 佣金提现
```
POST /distribution/commission/withdraw
Body: {
  "amount": 100.00,
  "tradePassword": "123456"
}
```

### 商城系统接口

#### 1. 获取商品列表
```
GET /mall/product/list?pageNum=1&pageSize=20
```

#### 2. 获取商品详情
```
GET /mall/product/{id}
```

#### 3. 创建订单
```
POST /mall/order/create
Body: {
  "productId": 1,
  "quantity": 1,
  "paymentMethod": 1,  // 1-余额 2-iOS内购
  "iosReceipt": "...",  // iOS支付凭证（可选）
  "referrerUserId": 123  // 推荐人ID（可选）
}
```

#### 4. 获取订单列表
```
GET /mall/order/list?pageNum=1&pageSize=20
```

#### 5. 支付订单
```
POST /mall/order/pay/{orderId}?iosReceipt=...
```

#### 6. 取消订单
```
POST /mall/order/cancel/{orderId}
```

## 部署说明

### 1. 数据库初始化

执行 SQL 脚本创建新表：

```bash
mysql -u root -p im_chat < im_chat_server/db_init_social_matching_mall.sql
```

### 2. 后端配置

确保 MyBatis 扫描到新的 Mapper XML 文件。在 `application.yml` 中配置：

```yaml
mybatis-plus:
  mapper-locations: classpath*:mapper/**/*.xml
```

### 3. iOS内购配置（可选）

如果需要支持iOS内购，需要：

1. 在Apple Developer中配置内购商品
2. 实现 iOS Receipt 验证逻辑（在 `MallServiceImpl.payOrder` 方法中）
3. 配置 Apple 的验证服务器地址

示例验证代码：
```java
// TODO: 验证 iOS receipt
String receiptData = order.getIosReceipt();
String verifyUrl = "https://buy.itunes.apple.com/verifyReceipt"; // 生产环境
// String verifyUrl = "https://sandbox.itunes.apple.com/verifyReceipt"; // 沙盒环境

// 调用Apple验证服务
// ...
```

### 4. 前端配置

在 UniApp 项目中，确保已安装必要的依赖：

```bash
cd im_chat_uniapp
npm install
```

## 使用流程

### 社交匹配流程

1. 用户进入"社交匹配"页面
2. 系统展示推荐的用户卡片
3. 用户左滑（不喜欢）或右滑（喜欢）
4. 如果双方互相喜欢，系统提示匹配成功
5. 用户可以开始聊天

### 分销商城流程

1. 用户激活成为分销商，获得推广码
2. 分享推广码给其他用户
3. 其他用户使用推广码注册/激活
4. 被推荐用户购买商品时，推荐人获得佣金
5. 分销商可以提现佣金到余额

### 商城购物流程

1. 用户浏览商品列表
2. 选择商品查看详情
3. 选择数量和支付方式
4. 创建订单并完成支付
5. 如果商品支持分销，自动计算并分配佣金

## 注意事项

1. **分销合规性**：确保分销机制符合当地法律法规，仅支持二级分销
2. **支付安全**：iOS内购需要严格验证receipt，防止欺诈
3. **佣金结算**：建议设置提现门槛和审核机制
4. **数据隐私**：匹配功能涉及用户信息，需注意隐私保护
5. **性能优化**：对于大量用户的匹配推荐，建议使用缓存和异步处理

## 后续优化建议

1. **匹配算法优化**：
   - 根据用户兴趣、地理位置等因素进行智能推荐
   - 实现基于机器学习的推荐系统

2. **分销功能增强**：
   - 添加分销商等级制度
   - 实现团队管理功能
   - 提供数据报表和分析

3. **商城功能扩展**：
   - 支持更多支付方式（微信、支付宝等）
   - 实现优惠券系统
   - 添加商品评价功能

4. **用户体验优化**：
   - 添加更多动画效果
   - 实现实时通知（匹配成功、佣金到账等）
   - 优化移动端交互体验

## 技术支持

如有问题，请联系开发团队或提交 Issue。
