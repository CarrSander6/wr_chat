# IM Chat 项目说明文档

## 项目概述

IM Chat 是一个功能完整的即时通讯系统，包含了服务端、管理后台、Web客户端、移动端客户端等多个子项目。系统支持单聊、群聊、音视频通话、红包等核心功能。

## 技术架构

### 后端技术栈
- Java 17/21
- Spring Boot 3.x
- WebSocket (Netty)
- MyBatis Plus
- Redis
- MySQL
- Redisson (分布式锁)

### 前端技术栈
- Vue 2/3
- Element UI/Plus
- Vite
- TypeScript
- uni-app (移动端)

## 项目结构

```
wr_chat/
├── im_chat_server/              # IM聊天核心服务端
├── im_chat_backstage/           # 后台管理系统服务端
├── im_chat_backstage_ui/        # 后台管理系统前端
├── im_chat_web/                 # Web聊天客户端
├── im_chat_uniapp/              # 移动端聊天应用(uni-app)
├── im-red-package/              # 红包服务
├── im-webview-group-rtc/        # 群组音视频通话WebView
└── im-webview-private-rtc/      # 私聊音视频通话WebView
```

## 子项目详细说明

### 1. im_chat_server - IM聊天核心服务端

**技术栈：** Spring Boot 3.3.1, Java 17, Netty, MyBatis Plus

**主要功能：**
- 用户认证与授权
- 单聊/群聊消息处理
- WebSocket长连接管理
- 好友关系管理
- 群组管理
- 音视频通话信令处理
- 红包功能
- 文件上传下载
- 用户黑名单
- 消息撤回
- 离线消息推送

**模块划分：**
- `im-platform`: 业务逻辑层，提供RESTful API接口
- `im-server`: WebSocket服务层，处理实时消息
- `im-common`: 公共模块，包含工具类、实体类等
- `im-client`: 客户端SDK

**核心依赖：**
- Spring Boot Starter Web
- Spring Boot Starter WebSocket
- MyBatis Plus 3.5.7
- Hutool 5.8.28
- Knife4j 4.5.0 (API文档)
- Redisson 3.21.3 (分布式锁)
- Minio 8.5.1 (文件存储)

**端口配置：**
- HTTP API: 默认 8080
- WebSocket: 默认 8081

**启动说明：**
```bash
cd im_chat_server
mvn clean install
java -jar im-platform/target/im-platform.jar
```

---

### 2. im_chat_backstage - 后台管理系统服务端

**技术栈：** Spring Boot 3.2.11, Java 21, MyBatis Plus

**主要功能：**
- 用户管理（封禁/解封）
- 群组管理
- 消息监控
- 敏感词管理
- 投诉举报处理
- 充值提现管理
- 红包记录查询
- 系统配置管理
- 数据统计分析
- 推送任务管理

**框架特点：**
- 基于若依(RuoYi)框架
- 支持多数据源
- 集成Sa-Token权限认证
- 支持代码生成器
- 集成SpringDoc API文档

**核心模块：**
- `ruoyi-admin`: 管理后台主模块
- `ruoyi-im`: IM业务模块
- `ruoyi-modules`: 系统模块（用户、角色、权限等）
- `ruoyi-common`: 公共模块

**启动说明：**
```bash
cd im_chat_backstage
mvn clean install
java -jar ruoyi-admin/target/ruoyi-admin.jar
```

---

### 3. im_chat_backstage_ui - 后台管理系统前端

**技术栈：** Vue 3, TypeScript, Element Plus, Vite

**主要功能：**
- 用户管理界面
- 群组管理界面
- 消息管理界面
- 数据统计看板
- 系统配置界面
- 敏感词管理
- 投诉处理
- 充值提现审核

**特性：**
- TypeScript类型安全
- Element Plus组件库
- Pinia状态管理
- Vue Router路由管理
- Axios HTTP客户端
- ECharts数据可视化
- 富文本编辑器(WangEditor)
- 工作流设计(BPMN.js)

**开发命令：**
```bash
cd im_chat_backstage_ui
npm install
npm run dev       # 开发环境
npm run build     # 生产构建
```

**环境配置：**
- 开发环境：`.env.development`
- 生产环境：`.env.production`

---

### 4. im_chat_web - Web聊天客户端

**技术栈：** Vue 2, Element UI, Electron

**主要功能：**
- 用户登录注册
- 单聊/群聊界面
- 消息收发（文本、图片、语音、视频）
- 好友列表管理
- 群组列表管理
- 音视频通话
- 红包收发
- 文件传输
- 表情包
- 消息搜索
- 截图功能

**特性：**
- 支持Web浏览器
- 支持Electron桌面应用
- LocalForage本地存储
- 拼音搜索(pinyin-pro)
- 音频录制(js-audio-recorder)
- 截图功能(electron-screenshots)

**开发命令：**
```bash
cd im_chat_web
npm install
npm run serve          # Web开发模式
npm run build          # Web构建
npm run electron:serve # Electron开发模式
npm run electron:build # Electron构建
```

---

### 5. im_chat_uniapp - 移动端聊天应用

**技术栈：** uni-app, Vue, uView Plus

**主要功能：**
- 跨平台移动端应用（iOS、Android、H5、小程序）
- 完整的聊天功能
- 通讯录管理
- 朋友圈功能
- 消息推送
- 语音视频通话
- 红包功能
- 个人中心

**特性：**
- 一套代码多端运行
- uView Plus UI组件库
- 拼音搜索
- 富文本编辑器(Quill)
- 二维码识别
- VConsole调试

**开发说明：**
- 使用HBuilderX开发工具
- 支持真机调试
- 支持云打包

---

### 6. im-red-package - 红包服务

**技术栈：** Spring Boot 2.6.13, Java 8, Redis, MyBatis

**主要功能：**
- 红包发放
- 红包抢夺
- 红包记录查询
- 红包金额分配算法
- 红包过期处理

**核心特性：**
- 使用Redis实现高并发抢红包
- 原子性操作保证数据一致性
- 红包金额随机分配算法
- 防止超抢和重复抢

**API接口：**
- `POST /red/packet/hand/out` - 发红包
- `POST /red/packet/rob` - 抢红包
- `POST /red/packet/isRob` - 查询是否已抢

**技术实现：**
- Redis List存储红包金额列表
- Redis Hash存储抢红包记录
- Lua脚本保证原子性操作

---

### 7. im-webview-group-rtc - 群组音视频通话

**技术栈：** Vue 2, Vant

**主要功能：**
- 群组音视频通话界面
- WebRTC连接管理
- 视频流展示
- 通话控制（静音、关闭摄像头、挂断）
- 参与者列表

**特性：**
- 嵌入到uni-app中使用
- 响应式布局适配移动端
- 支持多人视频通话

---

### 8. im-webview-private-rtc - 私聊音视频通话

**技术栈：** Vue 2

**主要功能：**
- 一对一音视频通话界面
- WebRTC连接管理
- 视频流展示
- 通话控制
- 通话状态显示

**特性：**
- 嵌入到uni-app中使用
- 移动端优化
- 低延迟通话

---

## 系统架构设计

### 整体架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Web客户端  │     │  移动端客户端 │     │  管理后台UI  │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                    │
       │    HTTP/WebSocket │                    │ HTTP
       │                   │                    │
       └───────────────────┴────────────────────┘
                           │
                ┌──────────┴──────────┐
                │                     │
         ┌──────▼──────┐      ┌──────▼──────┐
         │ IM Chat     │      │  后台管理    │
         │   Server    │      │   System    │
         └──────┬──────┘      └──────┬──────┘
                │                     │
         ┌──────┴──────┐      ┌──────┴──────┐
         │  红包服务    │      │  Redis      │
         └─────────────┘      └─────────────┘
                │                     │
                └──────────┬──────────┘
                           │
                    ┌──────▼──────┐
                    │   MySQL     │
                    └─────────────┘
```

### 消息流程

1. **单聊消息流程：**
   - 客户端 → WebSocket → IM Server
   - IM Server → 验证权限 → 存储消息
   - IM Server → 推送消息 → 在线用户
   - 离线消息 → Redis缓存 → 用户上线后拉取

2. **群聊消息流程：**
   - 客户端 → WebSocket → IM Server
   - IM Server → 验证群成员 → 存储消息
   - IM Server → 扇出推送 → 所有在线群成员
   - 离线消息 → Redis缓存 → 成员上线后拉取

3. **音视频通话流程：**
   - 客户端A → 发起通话 → IM Server
   - IM Server → 推送邀请 → 客户端B
   - 客户端B → 接受/拒绝 → IM Server → 客户端A
   - WebRTC → P2P连接 → 建立通话

### 数据存储

- **MySQL**: 用户信息、好友关系、群组信息、消息记录
- **Redis**: 在线状态、会话缓存、离线消息、红包数据
- **MinIO**: 文件存储（图片、视频、文件）

### 安全机制

- JWT Token认证
- 密码加密存储
- API接口防重复提交
- XSS防护
- SQL注入防护
- 敏感词过滤

---

## 开发指南

### 环境要求

**后端：**
- JDK 17+ (im_chat_server)
- JDK 21+ (im_chat_backstage)
- JDK 8+ (im-red-package)
- Maven 3.6+
- MySQL 8.0+
- Redis 6.0+

**前端：**
- Node.js 16+
- npm/yarn

### 本地开发

1. **启动数据库：**
   ```bash
   # 启动MySQL
   mysql -u root -p
   # 创建数据库并导入SQL脚本
   
   # 启动Redis
   redis-server
   ```

2. **启动后端服务：**
   ```bash
   # 启动IM服务器
   cd im_chat_server
   mvn spring-boot:run
   
   # 启动后台管理系统
   cd im_chat_backstage
   mvn spring-boot:run
   
   # 启动红包服务
   cd im-red-package
   mvn spring-boot:run
   ```

3. **启动前端服务：**
   ```bash
   # Web客户端
   cd im_chat_web
   npm install && npm run serve
   
   # 管理后台
   cd im_chat_backstage_ui
   npm install && npm run dev
   ```

### 代码规范

- Java代码遵循阿里巴巴Java开发手册
- 前端代码使用ESLint + Prettier
- Git提交规范：feat/fix/docs/style/refactor/test/chore

---

## 部署指南

### Docker部署

```bash
# 构建镜像
docker build -t im-chat-server:latest ./im_chat_server
docker build -t im-chat-backstage:latest ./im_chat_backstage

# 运行容器
docker-compose up -d
```

### 生产环境配置

1. 修改配置文件中的数据库连接
2. 配置Redis连接
3. 配置文件存储路径（MinIO）
4. 配置域名和SSL证书
5. 配置Nginx反向代理

---

## 性能优化

- 使用Redis缓存热点数据
- WebSocket连接池管理
- 消息分页加载
- 图片压缩和懒加载
- CDN加速静态资源
- 数据库索引优化
- 读写分离

---

## 未来规划

- [ ] 支持更多消息类型（位置、名片等）
- [ ] 机器人接入
- [ ] 消息加密
- [ ] 多语言支持
- [ ] 音视频通话录制
- [ ] 朋友圈功能增强
- [ ] 小程序版本
- [ ] 聊天记录云同步

---

## 联系方式

如有问题，请提交Issue或Pull Request。

---

## 许可证

本项目采用 MIT 许可证。
